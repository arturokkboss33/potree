<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Potree Viewer</title>

    <link rel="stylesheet" type="text/css" href="libs/potree/potree.css">
    <link rel="stylesheet" type="text/css" href="../../libs/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="../../libs/openlayers3/ol.css">
    <link rel="stylesheet" type="text/css" href="../../libs/spectrum/spectrum.css">
    <link rel="stylesheet" type="text/css" href="../../libs/jstree/themes/mixed/style.css">
</head>

<body>
    <script src="../../libs/jquery/jquery-3.1.1.min.js"></script>
    <script src="../../libs/spectrum/spectrum.js"></script>
    <script src="../../libs/jquery-ui/jquery-ui.min.js"></script>
    <script src="../../libs/three.js/build/three.min.js"></script>
    <script src="../../libs/three.js/extra/lines.js"></script>
    <script src="../../libs/other/BinaryHeap.js"></script>
    <script src="../../libs/tween/tween.min.js"></script>
    <script src="../../libs/d3/d3.js"></script>
    <script src="../../libs/proj4/proj4.js"></script>
    <script src="../../libs/openlayers3/ol.js"></script>
    <script src="../../libs/i18next/i18next.js"></script>
    <script src="../../libs/jstree/jstree.js"></script>
    <script src="../../build/potree/potree.js"></script>
    <script src="../../libs/plasio/js/laslaz.js"></script>

    <!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
    <!-- INCLUDE SETTINGS HERE -->

    <div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
        <div id="potree_render_area"></div>
        <div id="potree_sidebar_container"> </div>
    </div>

    <script>
    
        // >>> USER DEFINED FUNCTIONS << //
        function processData(csv_file) {
            var all_rows = csv_file.split(/\r?\n/);
            var header = all_rows[0].split('|');
            var extracted_csv = [];
            console.log(header)

            for (var i = 1; i < all_rows.length; i++) {
                var curr_elems = all_rows[i].split('|');
                if (curr_elems.length == header.length) {
                    var curr_row = {};
                    for (var j = 0; j < header.length; j++) {

                        curr_row[header[j]] = curr_elems[j];
                    }
                    extracted_csv.push(curr_row);
                }
            }
            //console.log(extracted_csv)
            return extracted_csv
        }
        // >>> USER DEFINED FUNCTIONS << //

        // >>> INITIAL SETUP OF POTREE VIEW <<< //
	    window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1*1000*1000);
		viewer.loadSettingsFromURL();
		viewer.setBackground("gradient"); // ["skybox", "gradient", "black", "white"];
		viewer.setDescription(``);
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			//$("#menu_appearance").next().show();
			//$("#menu_tools").next().show();
			$("#menu_scene").next().show();
			viewer.toggleSidebar();
		});

		let sceneSG = new Potree.Scene();
		viewer.setScene(sceneSG);
        // >>> INITIAL SETUP OF POTREE VIEW <<< //

        // >>> POINTCLOUD 1 <<< //
		Potree.loadPointCloud("pointclouds/visualization/cloud.js", "visualization", function(e){
			sceneSG.addPointCloud(e.pointcloud);			
			//let pointcloud = e.pointcloud;
			//viewer.scene.addPointCloud(pointcloud);
			//material.pointColorType = Potree.PointColorType.RGB; // any Potree.PointColorType.XXXX !!This causes an error in bew potree
            let material = e. pointcloud.material;
            material.size = 1;
			material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
			material.shape = Potree.PointShape.SQUARE;
			
			{ //START SET OF ACTIONS AND ANNOTATIONS TO OVERLAY
                /*
                // EXAMPLE ANNOTATION
                let aAbout1 = new Potree.Annotation({
                            position: [-292.026, 134.87, -61.013],
                            title: "About Annotations 2",
                            cameraPosition: [-237.97, 189.046, -44.841],
                            cameraTarget: [-279.455, 188.746, -72.042],
                            description: `<ul><li>Click on the annotation label to move a predefined view.</li> 
                            <li>Click on the icon to execute the specified action.</li>
                            In this case, the action will bring you to another scene and point cloud.</ul>`
                            });
                //viewer.scene.annotations.add(aAbout1);
                sceneSG.annotations.add(aAbout1);
                */
                
                // >>> READ CSV WITH ANOTATIONS FOR THIS POINTCLOUD <<< //
                $(document).ready(function() 
                {
                    $.ajax({
                        type: "GET",
                        url: "annotations/bunker_annotation.csv",
                        dataType: "text",
                        success: function(data) {
                            extracted_csv = processData(data);

                            var i_anno;
                            for (i_anno = 0; i_anno < extracted_csv.length; i_anno++)
                            {

                                curr_pos = [];
                                curr_cam_pos = [];
                                curr_cam_tgt = [];
                                curr_title = "";
                                curr_description = "";

                                if (extracted_csv[i_anno]["link"] !== "" && extracted_csv[i_anno]["link"] !== "-")
                                {
                                    link = extracted_csv[i_anno]["link"];
                                    let elTitle = $(`
                                    <span>
                                        ${extracted_csv[i_anno]["title"]}
                                        <a href=${link} target="_blank">
                                        <img src="${Potree.resourcePath}/icons/goto.svg" 
                                            name="action_set_scene"
                                            class="annotation-action-icon" 
                                            style="filter: invert(1);" >
                                        </a>
                                    </span>`);

                                    temp_title = extracted_csv[i_anno]["title"]
                                    elTitle.toString = () => temp_title
                                    curr_title = elTitle;

                                } else
                                    curr_title = extracted_csv[i_anno]["title"];

                                if (extracted_csv[i_anno]["description"] !== "" && extracted_csv[i_anno]["description"] !== "-")
                                {
                                    curr_description = extracted_csv[i_anno]["description"]
                                    if (extracted_csv[i_anno]["image"] !== "" && extracted_csv[i_anno]["image"] !== "-")
                                    {
                                        curr_description = curr_description.concat(`<br><br><center><a href=${extracted_csv[i_anno]["image"]} target="_blank"><img src=${extracted_csv[i_anno]["image"]} class="annotation-images"></a></center>`)
                                    }
                                }
                                    else if (extracted_csv[i_anno]["image"] !== "" && extracted_csv[i_anno]["image"] !== "-")
                                    {
                                        curr_description = `<br><center><a href=${extracted_csv[i_anno]["image"]} target="_blank"><img src=${extracted_csv[i_anno]["image"]} class="annotation-images"></a></center>`
                                    }

                                    if (parseFloat(extracted_csv[i_anno]["pos_x"]) !== "" && extracted_csv[i_anno]["pos_x"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["pos_y"]) !== "" && extracted_csv[i_anno]["pos_y"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["pos_z"]) !== "" && extracted_csv[i_anno]["pos_z"] !== "-") 
                                    {
                                        curr_pos = [parseFloat(extracted_csv[i_anno]["pos_x"]), parseFloat(extracted_csv[i_anno]["pos_y"]), parseFloat(extracted_csv[i_anno]["pos_z"])];
                                    }

                                    if (curr_pos.length && extracted_csv[i_anno]["cam_pos_x"] !== "" && extracted_csv[i_anno]["cam_pos_x"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["cam_pos_y"]) !== "" && extracted_csv[i_anno]["cam_pos_y"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["cam_pos_z"]) !== "" && extracted_csv[i_anno]["cam_pos_z"] !== "-") 
                                    {
                                        curr_cam_pos = [parseFloat(extracted_csv[i_anno]["cam_pos_x"]), parseFloat(extracted_csv[i_anno]["cam_pos_y"]), parseFloat(extracted_csv[i_anno]["cam_pos_z"])];
                                    }

                                    if (parseFloat(extracted_csv[i_anno]["cam_tgt_x"]) !== "" && extracted_csv[i_anno]["cam_tgt_x"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["cam_tgt_y"]) !== "" && extracted_csv[i_anno]["cam_tgt_y"] !== "-" &&
                                        parseFloat(extracted_csv[i_anno]["cam_tgt_z"]) !== "" && extracted_csv[i_anno]["cam_tgt_z"] !== "-")
                                    {
                                        curr_cam_tgt = [parseFloat(extracted_csv[i_anno]["cam_tgt_x"]), parseFloat(extracted_csv[i_anno]["cam_tgt_y"]), parseFloat(extracted_csv[i_anno]["cam_tgt_z"])]
                                    }

                                    if (curr_pos.length && curr_cam_pos.length && curr_cam_tgt)
                                    {
                                        let annotation = new Potree.Annotation({
                                            position: curr_pos,
                                            cameraPosition: curr_cam_pos,
                                            cameraTarget: curr_cam_tgt,
                                            title: curr_title,
                                            description: curr_description,
                                        });
                                        //viewer.scene.annotations.add(annotation);
                                        sceneSG.annotations.add(annotation);
                                    } else if (curr_pos.length)
                                    {
                                        let annotation = new Potree.Annotation({
                                            position: curr_pos,
                                            title: curr_title,
                                            description: curr_description,
                                        });
                                        //viewer.scene.annotations.add(annotation);
                                        sceneSG.annotations.add(annotation);
                                    }

                                //opens annotation only if clicked
                                //annotation.domElement.off("mouseenter");
                                //annotation.domElement.off("mouseleave");
                                //annotation.addEventListener("click", () => {annotation.setHighlighted(!annotation.isHighlighted);});
                            }
                        }
                    });
                }); // >>> FINISH READ CSV WITH ANOTATIONS FOR THIS POINTCLOUD <<< //

            } //FINISH SET OF ACTIONS AND ANNOTATIONS TO OVERLAY

            viewer.fitToScreen();

		});// >>> POINTCLOUD 1 <<< //

    </script>


</body>

</html>

